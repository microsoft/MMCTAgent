# Ingestion consumer Dockerfile
ARG BASE_IMAGE=mmct-base:latest
FROM ${BASE_IMAGE}

WORKDIR /app

# Copy application-specific files (build context is already in app/ directory)
COPY . app/

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONPATH=/app:/app/app

# Create non-root user for security
RUN groupadd -r consumer && useradd -r -g consumer consumer
RUN chown -R consumer:consumer /app /app/media /app/logs
USER consumer

# Health check for consumer process
HEALTHCHECK --interval=60s --timeout=30s --start-period=10s --retries=3 \
    CMD ps aux | grep -q "[p]ython.*ingestion_consumer.py" || exit 1

CMD ["python", "app/ingestion_consumer.py"]